extern crate uplc;
extern crate pallas_primitives;

use pallas_primitives::babbage::CostMdls;
use pallas_primitives::{
    babbage::{TransactionInput, TransactionOutput},
    Fragment,
};
use pallas_traverse::{Era, MultiEraTx};
use uplc::machine::cost_model::ExBudget;
use uplc::tx;
use uplc::tx::script_context::{ResolvedInput, SlotConfig};

use anyhow::anyhow;
use anyhow::{Result};

pub fn eval_phase_two(
    tx_hex: &str,
    inputs: &str,
    outputs: &str,
    cost_mdls: &str,
    ex_budget: ExBudget,
    slot_config: SlotConfig,
) -> Result<String> {
    let tx_bytes: Vec<u8> = hex::decode(tx_hex).map_err(|err| anyhow!(format!("HEX: {:?}", err)))?;

    let tx_bytes: &[u8] = tx_bytes.as_slice();

    let tx: MultiEraTx = MultiEraTx::decode(Era::Babbage, &tx_bytes)
        .or_else(|_| MultiEraTx::decode(Era::Alonzo, &tx_bytes))
        .map_err(|err| anyhow!(format!("PALLAS: {:?}", err)))?;

    let inputs_bytes: Vec<u8> = hex::decode(inputs).map_err(|err| anyhow!(format!("HEX: {:?}", err)))?;
    let outputs_bytes: Vec<u8> = hex::decode(outputs).map_err(|err| anyhow!(format!("HEX: {:?}", err)))?;

    let inputs = Vec::<TransactionInput>::decode_fragment(&inputs_bytes)
        .map_err(|err| anyhow!(format!("PALLAS: {:?}", err)))?;

    let outputs = Vec::<TransactionOutput>::decode_fragment(&outputs_bytes)
        .map_err(|err| anyhow!(format!("PALLAS: {:?}", err)))?;

    let resolved_inputs: Vec<ResolvedInput> = inputs
        .iter()
        .zip(outputs.iter())
        .map(|(input, output)| ResolvedInput {
            input: input.clone(),
            output: output.clone(),
        })
        .collect();

    let cost_mdls_bytes_vec = hex::decode(cost_mdls).map_err(|err| anyhow!(format!("HEX: {:?}", err)))?;
    let cost_mdls_bytes = cost_mdls_bytes_vec.as_slice();

    let cost_mdls =
        CostMdls::decode_fragment(cost_mdls_bytes).map_err(|err| anyhow!(format!("PALLAS: {:?}", err)))?;

    if let Some(tx_babbage) = tx.as_babbage() {
        let redeemers = tx::eval_phase_two(
            tx_babbage,
            &resolved_inputs,
            Some(&cost_mdls),
            Some(&ex_budget),
            &slot_config,
            true,
            |_| {},
        )
        .map_err(|err| anyhow!(format!("AIKEN: {:?}", err)))?;

        let redeemer_bytes = minicbor::to_vec(redeemers).map_err(|err| anyhow!(format!("CBOR: {:?}", err)))?;
        let redeemer_bytes = redeemer_bytes.as_slice();

        let redeemers_hex = hex::encode(redeemer_bytes);

        return Ok(redeemers_hex);
    }

    return Result::Err(anyhow!(
        "PALLAS: unable to deserialise transaction and deserialise it into pallas pallas_traverse::MultiEraTx!
        Possible causes: either transaction is invalid or downstream's pallas library doesn't this transaction yet."
    ));
}

pub fn apply_params_to_plutus_script(params: &str, plutus_script: &str) -> Result<String> {
    let params_vec: Vec<u8> = hex::decode(params).map_err(|err| anyhow!(format!("HEX: {:?}", err)))?;
    let params_bytes: &[u8] = params_vec.as_slice();

    let plutus_script_vec: Vec<u8> = hex::decode(plutus_script).map_err(|err| anyhow!(format!("HEX: {:?}", err)))?;
    let plutus_script_bytes: &[u8] = plutus_script_vec.as_slice();

    let plutus_script_result = uplc::tx::apply_params_to_script(&params_bytes, &plutus_script_bytes)
        .map_err(|err| anyhow!(format!("AIKEN: {:?}", err)))?;

    let plutus_script_hex = hex::encode(plutus_script_result);

    return Ok(plutus_script_hex);
}

#[cfg(test)]
mod tests {
    use crate::transaction::{apply_params_to_plutus_script, eval_phase_two};
    use uplc::machine::cost_model::ExBudget;
    use uplc::tx::script_context::SlotConfig;

    #[test]
    pub fn eval_phase_test_all_ok1() {
        let tx_hex = "84a600818258202da783ed1161732f1f59319eca1f9da38afde36445ae065b2250a8e6e7362cfe000181825839000d30c6d716fd6c48ab546f0b66fd5faaa3a2f0ccecf0a72ea8c04a30a91cf775fb8e1fdfe882b26014f11d56bd47681270a55fd15e6d064c1a003d090002000d818258202da783ed1161732f1f59319eca1f9da38afde36445ae065b2250a8e6e7362cfe0110825839000d30c6d716fd6c48ab546f0b66fd5faaa3a2f0ccecf0a72ea8c04a30a91cf775fb8e1fdfe882b26014f11d56bd47681270a55fd15e6d064c821b00000002b64c0608a3581c4be3ff6f6ac1303b65adaa8c31b73395f488a6c3370b9694e6df21daa14d4275726e546f6b656e54657374185d581c689903d80b71e0570fea2fdaaa4bf80989785ed2a2cd57da0d9a7d0aa148746f6b656e5f3132197530581cc48f707fea6f08af67a8c06c9bea5b3ec847f5901dc08420cd7f8adea14a4f676d696f73546573741b0000001bf08eb000111a000f4240a20581840000182482000006815907a65907a3010000323322323232323232323232323232323322323232323222232325335323232333573466e1ccc07000d200000201e01d3333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd405c060d5d0a80619a80b80c1aba1500b33501701935742a014666aa036eb94068d5d0a804999aa80dbae501a35742a01066a02e0446ae85401cccd5406c08dd69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40b5d69aba15002302e357426ae8940088c98c80c0cd5ce01881801709aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a816bad35742a004605c6ae84d5d1280111931901819ab9c03103002e135573ca00226ea8004d5d09aba2500223263202c33573805a05805426aae7940044dd50009aba1500533501775c6ae854010ccd5406c07c8004d5d0a801999aa80dbae200135742a00460426ae84d5d1280111931901419ab9c029028026135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860226ae84d5d1280211931900d19ab9c01b01a018375a00a6eb4014405c4c98c805ccd5ce24810350543500017135573ca00226ea800448c88c008dd6000990009aa80b911999aab9f0012500a233500930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500f014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a016eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355014223233335573e0044a010466a00e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200222440042442446600200800624464646666ae68cdc3a800a40004642446004006600a6ae84d55cf280191999ab9a3370ea0049001109100091931900819ab9c01101000e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200923333573466e1d40092000200923263200633573800e00c00800626aae74dd5000a4c240029210350543100320013550032225335333573466e1c0092000005004100113300333702004900119b80002001122002122001112323001001223300330020020011f5f6";
        let inputs = "818258202da783ed1161732f1f59319eca1f9da38afde36445ae065b2250a8e6e7362cfe00";
        let outputs = "81a300581d70b010c0888e93aa488d941ba4839136fceb9b9a9ec310a573299286d7011a003d0900028201d8184108";
        let cost_mdls = "a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201b00000004a817c8001b00000004a817c8001a009063b91903fd0a1b00000004a817c800001b00000004a817c800";

        let slot_config = SlotConfig {
            zero_time: 1596059091000,
            zero_slot: 0,
            slot_length: 1000,
        };

        let ex_budget = ExBudget {
            cpu: 10000000000,
            mem: 16000000,
        };

        let redeemer =
            eval_phase_two(tx_hex, inputs, outputs, cost_mdls, ex_budget, slot_config).unwrap();
        assert_eq!("818400001824821a00078d1a1a09552e8e", redeemer);
    }

    #[test]
    pub fn eval_phase_test_all_ok2() {
        let tx_hex = "84a600858258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739008258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739018258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739028258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739038258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739040182a300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00132342028201d8185855d8799fa3d8799f1a0ddaf2d51a00158f74ffd8799f001a0008a3ed00ffd8799f1a1148bbdf1a001328b4ffd8799f001a0017c5491a00510466ffd8799f1a1148bbdf1a0018fb3dffd8799f1a0008a3ed0000ff00ff82583900bee45311d846fc0a8b6bc6c1d06cc212f577efa60086a9c26783c6eb1708ad5cfcd595d49f19695c86d335a339dc8d4130170e38a2cb0c961a004ce13602000d818258203974e34e3cde1dc35f06f7bd6c887c927af5277bc270c74fbab06410cf98cefd051082583900bee45311d846fc0a8b6bc6c1d06cc212f577efa60086a9c26783c6eb1708ad5cfcd595d49f19695c86d335a339dc8d4130170e38a2cb0c961b00000004a6eed66d111a000f4240a20585840000d8799f58383531333163323432386237303837623866383435383533343166306265313436303039313333356535303130353562303830383562656162ff820000840001d8799f58383534393438346266333764386361306235366332373266346361303764633963323633666532343732346464376665363635353165623066ff820000840002d8799f58386563643032656335366165323862653762326132396333313737313235623139383166616631623631336636336632616663643738366135ff820000840003d8799f58383138653033306639383861653735633762356634653433303334646239383333636661383063616532303263373339376461313861393135ff820000840004d8799f58383336666232323131666138616535383163653439653863393136323835396330663531666535633632333763386336363764376136306361ff8200000681590de0590ddd01000032323232323232323232322225333006323232323232323232323232323232323232323232533301b3370e0029000099191919192999810299981018068020998051bac33019301a33019301a01b48001200400114a0266600e02c02a02e2940cdd2a40006604a6e98004cc094dd42400097ae0323232323232323232330020014bd6f7b63000498008009112999816001080089919191919199980e199804004002003199991111999806802001801000a5eb7bdb180cdd2a4000660646ea0008cc0c8dd4000a5eb80cdd2a4000660646ea0dd6998129813001a4004660646ea0dd6998129813001a4008660646ea0dd6998129813001a400c97ae001a01b01a375a66048604a00890031bad33023302400348010c8c8c8c8c8cdd2a400066068008660686ea000ccc0d0dd40011981a1ba80014bd701919806800a40006601a00890001919806000a40006601800690011919805800a400066016004900219ba548000cc0c0dd41bad33023302400148010cc0c0dd41bad330233024001480192f5c00046060006605c004600200244444a66605800826605a66ec000c0092f5bded8c0264646464a66605666ebccc01401c004cdd2a400097ae01330313376000e00c0102a66605666ebc01c0044cc0c4cdd800380300189981899bb000100233333009009003007006005302d003302d0023030005302e004223253330243370e00290010801099190009bad302c001301e003302637540044464664464a66604c66e1c005200213374a900125eb804c8c8cdd2a40006605c6ea0c0100052f5c06eb4c0b8004c08000cc0a0dd500100091bad3301d301e00448008cc00d2f5c301000081010100810102001299981199b87375a66038603a0069004000899b8700200114a06002002444a66604c004266e9520024bd700991929998119801801099ba548000cc0a4dd400125eb804ccc01401400400cc0a800cdd6981400119191919801000919191981219299981219b87001480004c8c8c8c8c8c8c8c8c8c94ccc0ccc0d800852615330304901364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606800260680046eb4c0c8004c0c8008dd6981800098180011bad302e001302e002375c6058002603c0042a6604c92012b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540020026052002603664a66604466e1d20043025375400220022a660489212a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163301a301b3301a301b0014800920040153001001222533302500214bd7009919198141801801199802802800801981480198138011bae302300130150171533301b3370e002900109919191919191929998112999811180780309980600b8008a50133300901801701914a064646644646660080064466e9520003302e374c66660306eaccc084c08800920003756660426044002900000b80b198171ba80044bd7000099ba548000cc0acdd325eb7bdb180cc0acdd4000a5eb8000c010c00400488894ccc0a800c40044c8c8cccc018018004010cc01000800cc0b8010c0b000cc8c8cc88cc00c0088c8c8cc0a0c94ccc0a0cdc3800a4000264646464a666062606800426605a66054006464646606064a66606066e1c00520001323232325333039303c002149854cc0d9241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a607400260740046eb4c0e0004c0a800c54cc0c92412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016303237540046606064a66606066e1c00520001323232323232533303b303e002149854cc0e1241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a607800260780046eb4c0e8004c0e8008dd6981c00098150010a9981924812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016303237540029318190011818000a4c2a6605c921364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606400260640046eacc0c0004c08800854cc0a92412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302a3754002a66604e66e1cdd6998101810800a4004008266e9520003302d0014bd70099ba5480092f5c0605a002603e64a66604c66e1d20043029375400220022a6605092012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163301e301f3301e301f0014800920040180043001001222533302800214bd70099191919299981399b87001480084ccc01c01c00c0144c8c8cc0bc004ccc02402401401cc0bc004c084008c0a4dd500098018011816001981500119b8000148008dd6981280098128011bae3023001301501714a0603a6ea8058888c8cc02000c8c8c8cdc78008021bae3026001301832533301f3370e900118111baa0011001153302149012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e0016330173018330173018001480012000332232323232001375c6050002603464a66604266e1d20023024375400220022a6604692012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633019301a33019301a33019301a00148009200048000c098004c060c94ccc07ccdc3a400060446ea8004400454cc0852412a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300600223375e66030603200290000010018009800800911299980f801099ba5480092f5c026464a6660386006004266e952000330220024bd700999802802800801981180198108011119801801119191980e19299980e19b87001480004c8c8c8c94ccc094c0a00084cc084cc07800c8c8c8cc090c94ccc090cdc3800a4000264646464a66605a60600042930a998152481364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a605c002605c0046eb4c0b0004c07800c54cc0992412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540046604864a66604866e1c00520001323232323232533302f3032002149854cc0b1241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606000260600046eb4c0b8004c0b8008dd69816000980f0010a9981324812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540029318130011812000a4c2a66044921364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a604c002604c0046eacc090004c05800854cc0792412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301e375400266ebc010004c084004c04cc94ccc068cdc3a4008603a6ea8004400454cc0712412a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633012301300148010c0040048894ccc07000852809919299980c98018010a5113330050050010033020003301e00224a2446644a66602c66e400080044cdd2a400097ae0153330163371e004002266e9520024bd70099ba5480112f5c06ecc008dd980091119ba548000cc068cdd2a4000660346ea0cdc01bad3300d300e00248000dd6998069807000a4000660346ea0cdc01bad3300d300e00248008dd6998069807000a4004660346ea0cdc01bad3300d300e00248010dd6998069807000a400897ae04bd7011111999802802001801000980080091111299980c00208018991919191999980480480199999805003800801003002803002980c801980c801180e002980d0021800800911111299980b80289980c19bb00040034bd6f7b630099191919299980b19baf330050080013374a900025eb804cc070cdd80040038048a99980b19baf0080011323253330183370e0029000099191981019bb000c001007302000130120021005301a375400266600c01000e00426603866ec0004008cccccc02802800c02001c018014c06000cc060008c06c018c064014dd61980218029980218028032400090021bac330033004330033004005480012000301000130023253330093370e900118061baa0011001153300b49012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300130020034800888c8ccc0040052000003222333300c3370e008004026466600800866e0000d200230150010012300b37540022930b180080091129998048010a4c26600a600260160046660060066018004002ae695cdab9c5573aaae7955cfaba05742ae881f5f6";
        let inputs = "858258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739008258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739018258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739028258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739038258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf73904";
        let outputs = "85a300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840633263363663326165613536343761653538306230663965636238333235343163326334633964376130653231633037633364616239373436356530383634331a0017c5491a1148bbdf1a001328b401ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840666135383433316333323432396538393861363132303064323632616133356338343562383365393035373239366430393337653061353237306264613938301a0008a3ed1a1148bbdf1a0018fb3d02ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840666135383433316333323432396538393861363132303064323632616133356338343562383365393035373239366430393337653061353237306264613938301a0008a3ed1a0ddaf2d51a00158f7401ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840666135383433316333323432396538393861363132303064323632616133356338343562383365393035373239366430393337653061353237306264613938301a0008a3ed1a1148bbdf1a001328b400ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840613661353431653461373064323739373839646262633639316636653065353932383364626261303762373133393866373837366332353363656164346261361a004860791a1148bbdf1a001328b400ff";
        let cost_mdls = "a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0223accc0a1a0374f693194a1f0a1a02515e841980b30a";

        let slot_config = SlotConfig {
            zero_time: 1596059091000,
            zero_slot: 0,
            slot_length: 1000,
        };

        let ex_budget = ExBudget {
            cpu: 10000000000,
            mem: 16000000,
        };

        let redeemer =
            eval_phase_two(tx_hex, inputs, outputs, cost_mdls, ex_budget, slot_config).unwrap();
        assert_eq!("85840000d8799f58383531333163323432386237303837623866383435383533343166306265313436303039313333356535303130353562303830383562656162ff821a00200b391a37c51a83840001d8799f58383534393438346266333764386361306235366332373266346361303764633963323633666532343732346464376665363635353165623066ff821a00202ad91a38011f46840002d8799f58386563643032656335366165323862653762326132396333313737313235623139383166616631623631336636336632616663643738366135ff821a00204a791a383d2409840003d8799f58383138653033306639383861653735633762356634653433303334646239383333636661383063616532303263373339376461313861393135ff821a00206a191a387928cc840004d8799f58383336666232323131666138616535383163653439653863393136323835396330663531666535633632333763386336363764376136306361ff821a002089b91a38b52d8f", redeemer);
    }

    #[test]
    pub fn eval_phase_test_failed_asserted_on_incorrect_constructor_variant() {
        let tx_hex = "84a6008582582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f5250082582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f5250182582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f5250282582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f5250382582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f525040182a300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00117e5c028201d818583cd8799fa2d8799f1a0ddaf2d51a0011afdeffd8799f02001a006025c2ffd8799f1a0ddaf2d51a00158f74ffd8799f1a00486079001a006025c2ff00ff82583900bee45311d846fc0a8b6bc6c1d06cc212f577efa60086a9c26783c6eb1708ad5cfcd595d49f19695c86d335a339dc8d4130170e38a2cb0c961a004e861c02000d82825820214135a716a3ace3e2e913936af4acf35a78fb45134d2f3c58fcebbb3aab9384018258203974e34e3cde1dc35f06f7bd6c887c927af5277bc270c74fbab06410cf98cefd051082583900bee45311d846fc0a8b6bc6c1d06cc212f577efa60086a9c26783c6eb1708ad5cfcd595d49f19695c86d335a339dc8d4130170e38a2cb0c961b00000004a727c396111a000f4240a20585840000d8799f58383631616564373365663933336163626365303164663764633932633865333264616335663662363032616634616365363161303366613561ff820000840001d8799f58386136366464613232643465323236303737396362393131303330616365623037663938616237353533316330643634356162613361653265ff820000840002d8799f58383038313164323261323933663730653333313265316333623562306332333833383361373030313937363039313933393339396634363532ff820000840003d8799f58383837633732363365386335643562663236326635383736336136383932343433613136633466636232373430356466376330343139343066ff820000840004d8799f58383231343065663462623264643031303963306164616431613262343034386230336165616437636565643233646437313338396534336431ff8200000681590de0590ddd01000032323232323232323232322225333006323232323232323232323232323232323232323232533301b3370e0029000099191919192999810299981018068020998051bac33019301a33019301a01b48001200400114a0266600e02c02a02e2940cdd2a40006604a6e98004cc094dd42400097ae0323232323232323232330020014bd6f7b63000498008009112999816001080089919191919199980e199804004002003199991111999806802001801000a5eb7bdb180cdd2a4000660646ea0008cc0c8dd4000a5eb80cdd2a4000660646ea0dd6998129813001a4004660646ea0dd6998129813001a4008660646ea0dd6998129813001a400c97ae001a01b01a375a66048604a00890031bad33023302400348010c8c8c8c8c8cdd2a400066068008660686ea000ccc0d0dd40011981a1ba80014bd701919806800a40006601a00890001919806000a40006601800690011919805800a400066016004900219ba548000cc0c0dd41bad33023302400148010cc0c0dd41bad330233024001480192f5c00046060006605c004600200244444a66605800826605a66ec000c0092f5bded8c0264646464a66605666ebccc01401c004cdd2a400097ae01330313376000e00c0102a66605666ebc01c0044cc0c4cdd800380300189981899bb000100233333009009003007006005302d003302d0023030005302e004223253330243370e00290010801099190009bad302c001301e003302637540044464664464a66604c66e1c005200213374a900125eb804c8c8cdd2a40006605c6ea0c0100052f5c06eb4c0b8004c08000cc0a0dd500100091bad3301d301e00448008cc00d2f5c301000081010100810102001299981199b87375a66038603a0069004000899b8700200114a06002002444a66604c004266e9520024bd700991929998119801801099ba548000cc0a4dd400125eb804ccc01401400400cc0a800cdd6981400119191919801000919191981219299981219b87001480004c8c8c8c8c8c8c8c8c8c94ccc0ccc0d800852615330304901364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606800260680046eb4c0c8004c0c8008dd6981800098180011bad302e001302e002375c6058002603c0042a6604c92012b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540020026052002603664a66604466e1d20043025375400220022a660489212a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163301a301b3301a301b0014800920040153001001222533302500214bd7009919198141801801199802802800801981480198138011bae302300130150171533301b3370e002900109919191919191929998112999811180780309980600b8008a50133300901801701914a064646644646660080064466e9520003302e374c66660306eaccc084c08800920003756660426044002900000b80b198171ba80044bd7000099ba548000cc0acdd325eb7bdb180cc0acdd4000a5eb8000c010c00400488894ccc0a800c40044c8c8cccc018018004010cc01000800cc0b8010c0b000cc8c8cc88cc00c0088c8c8cc0a0c94ccc0a0cdc3800a4000264646464a666062606800426605a66054006464646606064a66606066e1c00520001323232325333039303c002149854cc0d9241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a607400260740046eb4c0e0004c0a800c54cc0c92412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016303237540046606064a66606066e1c00520001323232323232533303b303e002149854cc0e1241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a607800260780046eb4c0e8004c0e8008dd6981c00098150010a9981924812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016303237540029318190011818000a4c2a6605c921364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606400260640046eacc0c0004c08800854cc0a92412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302a3754002a66604e66e1cdd6998101810800a4004008266e9520003302d0014bd70099ba5480092f5c0605a002603e64a66604c66e1d20043029375400220022a6605092012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163301e301f3301e301f0014800920040180043001001222533302800214bd70099191919299981399b87001480084ccc01c01c00c0144c8c8cc0bc004ccc02402401401cc0bc004c084008c0a4dd500098018011816001981500119b8000148008dd6981280098128011bae3023001301501714a0603a6ea8058888c8cc02000c8c8c8cdc78008021bae3026001301832533301f3370e900118111baa0011001153302149012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e0016330173018330173018001480012000332232323232001375c6050002603464a66604266e1d20023024375400220022a6604692012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633019301a33019301a33019301a00148009200048000c098004c060c94ccc07ccdc3a400060446ea8004400454cc0852412a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300600223375e66030603200290000010018009800800911299980f801099ba5480092f5c026464a6660386006004266e952000330220024bd700999802802800801981180198108011119801801119191980e19299980e19b87001480004c8c8c8c94ccc094c0a00084cc084cc07800c8c8c8cc090c94ccc090cdc3800a4000264646464a66605a60600042930a998152481364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a605c002605c0046eb4c0b0004c07800c54cc0992412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540046604864a66604866e1c00520001323232323232533302f3032002149854cc0b1241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606000260600046eb4c0b8004c0b8008dd69816000980f0010a9981324812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540029318130011812000a4c2a66044921364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a604c002604c0046eacc090004c05800854cc0792412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301e375400266ebc010004c084004c04cc94ccc068cdc3a4008603a6ea8004400454cc0712412a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633012301300148010c0040048894ccc07000852809919299980c98018010a5113330050050010033020003301e00224a2446644a66602c66e400080044cdd2a400097ae0153330163371e004002266e9520024bd70099ba5480112f5c06ecc008dd980091119ba548000cc068cdd2a4000660346ea0cdc01bad3300d300e00248000dd6998069807000a4000660346ea0cdc01bad3300d300e00248008dd6998069807000a4004660346ea0cdc01bad3300d300e00248010dd6998069807000a400897ae04bd7011111999802802001801000980080091111299980c00208018991919191999980480480199999805003800801003002803002980c801980c801180e002980d0021800800911111299980b80289980c19bb00040034bd6f7b630099191919299980b19baf330050080013374a900025eb804cc070cdd80040038048a99980b19baf0080011323253330183370e0029000099191981019bb000c001007302000130120021005301a375400266600c01000e00426603866ec0004008cccccc02802800c02001c018014c06000cc060008c06c018c064014dd61980218029980218028032400090021bac330033004330033004005480012000301000130023253330093370e900118061baa0011001153300b49012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300130020034800888c8ccc0040052000003222333300c3370e008004026466600800866e0000d200230150010012300b37540022930b180080091129998048010a4c26600a600260160046660060066018004002ae695cdab9c5573aaae7955cfaba05742ae881f5f6";
        let inputs = "8582582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f5250082582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f5250182582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f5250282582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f5250382582068368129e5057b6a314da2216c95087699ef6551fc7d7dcb316277790085f52504";
        let outputs = "85a300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840633263363663326165613536343761653538306230663965636238333235343163326334633964376130653231633037633364616239373436356530383634331a0017c5491a0ddaf2d51a0011afde00ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840613661353431653461373064323739373839646262633639316636653065353932383364626261303762373133393866373837366332353363656164346261361a004860791a0ddaf2d51a0011afde00ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840613661353431653461373064323739373839646262633639316636653065353932383364626261303762373133393866373837366332353363656164346261361a004860791a0ddaf2d51a00158f7400ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840633263363663326165613536343761653538306230663965636238333235343163326334633964376130653231633037633364616239373436356530383634331a0017c5491a0ddaf2d51a00158f7400ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840613661353431653461373064323739373839646262633639316636653065353932383364626261303762373133393866373837366332353363656164346261361a004860791a0ddaf2d51a00158f7402ff";
        let cost_mdls = "a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0223accc0a1a0374f693194a1f0a1a02515e841980b30a";

        let slot_config = SlotConfig {
            zero_time: 1596059091000,
            zero_slot: 0,
            slot_length: 1000,
        };

        let ex_budget = ExBudget {
            cpu: 10000000000,
            mem: 16000000,
        };

        let redeemer = eval_phase_two(tx_hex, inputs, outputs, cost_mdls, ex_budget, slot_config);
        assert!(redeemer.is_err());
        let error_msg = redeemer.map_err(|err| format!("{:?}", err)).err().unwrap();
        //println!("{:?}", error_msg);
        assert!(error_msg.contains("RedeemerError"));
    }

    #[test]
    pub fn eval_phase_test_failed_out_of_budget() {
        let tx_hex = "84a600858258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739008258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739018258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739028258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739038258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739040182a300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00132342028201d8185855d8799fa3d8799f1a0ddaf2d51a00158f74ffd8799f001a0008a3ed00ffd8799f1a1148bbdf1a001328b4ffd8799f001a0017c5491a00510466ffd8799f1a1148bbdf1a0018fb3dffd8799f1a0008a3ed0000ff00ff82583900bee45311d846fc0a8b6bc6c1d06cc212f577efa60086a9c26783c6eb1708ad5cfcd595d49f19695c86d335a339dc8d4130170e38a2cb0c961a004ce13602000d818258203974e34e3cde1dc35f06f7bd6c887c927af5277bc270c74fbab06410cf98cefd051082583900bee45311d846fc0a8b6bc6c1d06cc212f577efa60086a9c26783c6eb1708ad5cfcd595d49f19695c86d335a339dc8d4130170e38a2cb0c961b00000004a6eed66d111a000f4240a20585840000d8799f58383531333163323432386237303837623866383435383533343166306265313436303039313333356535303130353562303830383562656162ff820000840001d8799f58383534393438346266333764386361306235366332373266346361303764633963323633666532343732346464376665363635353165623066ff820000840002d8799f58386563643032656335366165323862653762326132396333313737313235623139383166616631623631336636336632616663643738366135ff820000840003d8799f58383138653033306639383861653735633762356634653433303334646239383333636661383063616532303263373339376461313861393135ff820000840004d8799f58383336666232323131666138616535383163653439653863393136323835396330663531666535633632333763386336363764376136306361ff8200000681590de0590ddd01000032323232323232323232322225333006323232323232323232323232323232323232323232533301b3370e0029000099191919192999810299981018068020998051bac33019301a33019301a01b48001200400114a0266600e02c02a02e2940cdd2a40006604a6e98004cc094dd42400097ae0323232323232323232330020014bd6f7b63000498008009112999816001080089919191919199980e199804004002003199991111999806802001801000a5eb7bdb180cdd2a4000660646ea0008cc0c8dd4000a5eb80cdd2a4000660646ea0dd6998129813001a4004660646ea0dd6998129813001a4008660646ea0dd6998129813001a400c97ae001a01b01a375a66048604a00890031bad33023302400348010c8c8c8c8c8cdd2a400066068008660686ea000ccc0d0dd40011981a1ba80014bd701919806800a40006601a00890001919806000a40006601800690011919805800a400066016004900219ba548000cc0c0dd41bad33023302400148010cc0c0dd41bad330233024001480192f5c00046060006605c004600200244444a66605800826605a66ec000c0092f5bded8c0264646464a66605666ebccc01401c004cdd2a400097ae01330313376000e00c0102a66605666ebc01c0044cc0c4cdd800380300189981899bb000100233333009009003007006005302d003302d0023030005302e004223253330243370e00290010801099190009bad302c001301e003302637540044464664464a66604c66e1c005200213374a900125eb804c8c8cdd2a40006605c6ea0c0100052f5c06eb4c0b8004c08000cc0a0dd500100091bad3301d301e00448008cc00d2f5c301000081010100810102001299981199b87375a66038603a0069004000899b8700200114a06002002444a66604c004266e9520024bd700991929998119801801099ba548000cc0a4dd400125eb804ccc01401400400cc0a800cdd6981400119191919801000919191981219299981219b87001480004c8c8c8c8c8c8c8c8c8c94ccc0ccc0d800852615330304901364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606800260680046eb4c0c8004c0c8008dd6981800098180011bad302e001302e002375c6058002603c0042a6604c92012b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540020026052002603664a66604466e1d20043025375400220022a660489212a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163301a301b3301a301b0014800920040153001001222533302500214bd7009919198141801801199802802800801981480198138011bae302300130150171533301b3370e002900109919191919191929998112999811180780309980600b8008a50133300901801701914a064646644646660080064466e9520003302e374c66660306eaccc084c08800920003756660426044002900000b80b198171ba80044bd7000099ba548000cc0acdd325eb7bdb180cc0acdd4000a5eb8000c010c00400488894ccc0a800c40044c8c8cccc018018004010cc01000800cc0b8010c0b000cc8c8cc88cc00c0088c8c8cc0a0c94ccc0a0cdc3800a4000264646464a666062606800426605a66054006464646606064a66606066e1c00520001323232325333039303c002149854cc0d9241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a607400260740046eb4c0e0004c0a800c54cc0c92412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016303237540046606064a66606066e1c00520001323232323232533303b303e002149854cc0e1241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a607800260780046eb4c0e8004c0e8008dd6981c00098150010a9981924812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016303237540029318190011818000a4c2a6605c921364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606400260640046eacc0c0004c08800854cc0a92412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302a3754002a66604e66e1cdd6998101810800a4004008266e9520003302d0014bd70099ba5480092f5c0605a002603e64a66604c66e1d20043029375400220022a6605092012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163301e301f3301e301f0014800920040180043001001222533302800214bd70099191919299981399b87001480084ccc01c01c00c0144c8c8cc0bc004ccc02402401401cc0bc004c084008c0a4dd500098018011816001981500119b8000148008dd6981280098128011bae3023001301501714a0603a6ea8058888c8cc02000c8c8c8cdc78008021bae3026001301832533301f3370e900118111baa0011001153302149012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e0016330173018330173018001480012000332232323232001375c6050002603464a66604266e1d20023024375400220022a6604692012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633019301a33019301a33019301a00148009200048000c098004c060c94ccc07ccdc3a400060446ea8004400454cc0852412a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300600223375e66030603200290000010018009800800911299980f801099ba5480092f5c026464a6660386006004266e952000330220024bd700999802802800801981180198108011119801801119191980e19299980e19b87001480004c8c8c8c94ccc094c0a00084cc084cc07800c8c8c8cc090c94ccc090cdc3800a4000264646464a66605a60600042930a998152481364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a605c002605c0046eb4c0b0004c07800c54cc0992412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540046604864a66604866e1c00520001323232323232533302f3032002149854cc0b1241364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a606000260600046eb4c0b8004c0b8008dd69816000980f0010a9981324812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302637540029318130011812000a4c2a66044921364c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2069742065787065637465640016375a604c002604c0046eacc090004c05800854cc0792412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301e375400266ebc010004c084004c04cc94ccc068cdc3a4008603a6ea8004400454cc0712412a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633012301300148010c0040048894ccc07000852809919299980c98018010a5113330050050010033020003301e00224a2446644a66602c66e400080044cdd2a400097ae0153330163371e004002266e9520024bd70099ba5480112f5c06ecc008dd980091119ba548000cc068cdd2a4000660346ea0cdc01bad3300d300e00248000dd6998069807000a4000660346ea0cdc01bad3300d300e00248008dd6998069807000a4004660346ea0cdc01bad3300d300e00248010dd6998069807000a400897ae04bd7011111999802802001801000980080091111299980c00208018991919191999980480480199999805003800801003002803002980c801980c801180e002980d0021800800911111299980b80289980c19bb00040034bd6f7b630099191919299980b19baf330050080013374a900025eb804cc070cdd80040038048a99980b19baf0080011323253330183370e0029000099191981019bb000c001007302000130120021005301a375400266600c01000e00426603866ec0004008cccccc02802800c02001c018014c06000cc060008c06c018c064014dd61980218029980218028032400090021bac330033004330033004005480012000301000130023253330093370e900118061baa0011001153300b49012a4173736572746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300130020034800888c8ccc0040052000003222333300c3370e008004026466600800866e0000d200230150010012300b37540022930b180080091129998048010a4c26600a600260160046660060066018004002ae695cdab9c5573aaae7955cfaba05742ae881f5f6";
        let inputs = "858258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739008258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739018258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739028258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf739038258205eaa26f02f743fb5ddfa7dd224537fd4a1c9cf92c9e2e8798e640453fffaf73904";
        let outputs = "85a300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840633263363663326165613536343761653538306230663965636238333235343163326334633964376130653231633037633364616239373436356530383634331a0017c5491a1148bbdf1a001328b401ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840666135383433316333323432396538393861363132303064323632616133356338343562383365393035373239366430393337653061353237306264613938301a0008a3ed1a1148bbdf1a0018fb3d02ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840666135383433316333323432396538393861363132303064323632616133356338343562383365393035373239366430393337653061353237306264613938301a0008a3ed1a0ddaf2d51a00158f7401ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840666135383433316333323432396538393861363132303064323632616133356338343562383365393035373239366430393337653061353237306264613938301a0008a3ed1a1148bbdf1a001328b400ffa300581d7027bb75b503c762c185b829d924291b24168690e132ff952a1e5b40aa011a00133418028201d8185856d8799f5840613661353431653461373064323739373839646262633639316636653065353932383364626261303762373133393866373837366332353363656164346261361a004860791a1148bbdf1a001328b400ff";
        let cost_mdls = "a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0223accc0a1a0374f693194a1f0a1a02515e841980b30a";

        let slot_config = SlotConfig {
            zero_time: 1596059091000,
            zero_slot: 0,
            slot_length: 1000,
        };

        let ex_budget = ExBudget { cpu: 1, mem: 1 };

        let redeemer = eval_phase_two(tx_hex, inputs, outputs, cost_mdls, ex_budget, slot_config);
        assert!(redeemer.is_err());
        let error_msg = redeemer.map_err(|err| format!("{:?}", err)).err().unwrap();

        //println!("{:?}", error_msg);

        assert!(error_msg.contains("RedeemerError"));
        assert!(error_msg.contains("OutOfExError"));
    }

    #[test]
    pub fn eval_phase_two_l1_transaction_with_negative_transaction_utxo_output_should_fail() {
        let tx_hex = "84a60081825820fe15eb46adbb14eefc7f366382006c415d7e9bc03499d3bc9ed528ca5f7d4a57080182a300581d70e37db487fbd58c45d059bcbf5cd6b1604d3bec16cf888f1395a4ebc4011a0011d28a028201d8185841d8799fa1d8799f1a125614ac1a002829e9ffd8799f1a008c6dc80000ff58205e371fd490fc09698042af01219446484dbea5fa9db55e42e1f3d145aec4dc4a00ff82583900bee45311d846fc0a8b6bc6c1d06cc212f577efa60086a9c26783c6eb1708ad5cfcd595d49f19695c86d335a339dc8d4130170e38a2cb0c9639b93102000d81825820b5f6312f937688af95106ba4d4fc0d7b71c19a7d5e1e0ea043c3cd82325ce815011082583900bee45311d846fc0a8b6bc6c1d06cc212f577efa60086a9c26783c6eb1708ad5cfcd595d49f19695c86d335a339dc8d4130170e38a2cb0c961b0000002e8fb22e45111a000f4240a20581840000d8799f58205e371fd490fc09698042af01219446484dbea5fa9db55e42e1f3d145aec4dc4aff8200000681583d583b0100003232323232323222253330064a22930b180080091129998030010a4c26600a6002600e0046660060066010004002ae695cdaab9f5742ae89f5f6";
        let inputs = "81825820fe15eb46adbb14eefc7f366382006c415d7e9bc03499d3bc9ed528ca5f7d4a5708";
        let outputs = "81a300581d70e37db487fbd58c45d059bcbf5cd6b1604d3bec16cf888f1395a4ebc4011a00111958028201d8185836d8799f58208941f1c54df0bc5461015e6cf41d5c407abf55515539e8e1f4f1bbc928de4c161a008c6dc81a125614ac1a002829e902ff";
        let cost_mdls = "a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0223accc0a1a0374f693194a1f0a1a02515e841980b30a";

        let slot_config = SlotConfig {
            zero_time: 1596059091000,
            zero_slot: 0,
            slot_length: 1000,
        };

        let ex_budget = ExBudget {
            cpu: 10000000000,
            mem: 16000000,
        };

        let redeemer = eval_phase_two(tx_hex, inputs, outputs, cost_mdls, ex_budget, slot_config);
        assert!(redeemer.is_err());
        let error_msg = redeemer.map_err(|err| format!("{:?}", err)).err().unwrap();
        //println!("{:?}", error_msg);
        assert!(error_msg.contains("expected array"));
    }

    #[test]
    pub fn eval_phase_test_hydra_tx_fails_due_to_out_of_budget() {
        let tx_hex = "84a600958258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c008258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c018258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c028258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c038258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c048258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c058258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c068258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c078258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c088258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c098258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0a8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0b8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0c8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0d8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0e8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0f8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c108258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c118258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c128258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c138258206df7b1c45dfe4ed78bc4406ea601329b5dd3d4d83deab80a957b2dd3d3a154f918640182a300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e011a000f4240028201d81859021bd8799fb4d8799f1a010ab5111a0002b852ffd8799f00001a0094b10cffd8799f1a010ab5111a0037af8dffd8799f1a002b6a890000ffd8799f1a01302e331a000923a3ffd8799f001a004747bd00ffd8799f1a01302e331a0018099bffd8799f1a009142ec0000ffd8799f1a01302e331a005abde1ffd8799f00001a0091ced6ffd8799f1a0389bb441a001c4899ffd8799f001a0054c42600ffd8799f1a0389bb441a00262140ffd8799f1a005bf2c20000ffd8799f1a03c174dd1a0013c2fcffd8799f1a004fea910000ffd8799f1a03c174dd1a0046fcb7ffd8799f1a0032e4410000ffd8799f1a04d578671a0018ba36ffd8799f001a00475f9100ffd8799f1a094fbd981a002e6bdeffd8799f00001a007ed75bffd8799f1a0eca615d1a000ed4e5ffd8799f00001a0086bcb1ffd8799f1a0eca615d1a00143c1bffd8799f1a0023c4e40000ffd8799f1a0eca615d1a002c7ac2ffd8799f001a008e9ffc00ffd8799f1a0eca615d1a0053eff0ffd8799f001a0054c42600ffd8799f1a1506cd001a00356482ffd8799f00001a007ed75bffd8799f1a1506cd001a004fa2d5ffd8799f1a007087740000ffd8799f1a1739aead1a00106979ffd8799f001a0058109200ffd8799f1a1739aead1a0028d2d5ffd8799f001a0010acee00ffd8799f1a1739aead1a003a697dffd8799f00001a0072f318ff5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff82581d60f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d1b0000001748662b0b02000d818258206df7b1c45dfe4ed78bc4406ea601329b5dd3d4d83deab80a957b2dd3d3a154f918641082581d60f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d1b0000001748756d4b111a000f4240a20594840000d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840001d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840002d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840003d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840004d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840005d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840006d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840007d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840008d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840009d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff82000084000ad8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff82000084000bd8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff82000084000cd8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff82000084000dd8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff82000084000ed8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff82000084000fd8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840010d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840011d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840012d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff820000840013d8799f5820848ff129735e09d87a76cb5a0b53a53f7294d5be92f16da39800a36fe3d0adceff8200000681590fae590fab010000323232323232323232323232323232222533300a3232323232323232323232323232323232323232323232323232323232323253330293370e900000d89919191919191918099981b199818000a60103d87a80004c0103d87980003303633303033300c0240230254c0103d87a80004c0103d87980003303633303033008375866058605c66058605c04e90002400800498103d87a80004c0103d87980004bd7019b8f0050023374a90001981a1ba600233034375200297ae032375c6605460580029001198090011180b1bb30013232323232323232330010094bd6f7b6301800800911299981d0010800899191919191999812999804004002003199911199980625eb7bdb18000c008004cdd2a4000660806ea0008cc100dd4000a5eb80cdd2a4000660806ea0dd69981b181c001a4004660806ea0dd69981b181c001a4008660806ea0dd69981b181c001a400c97ae002b02a02b375a6606a606e00890031bad33034303600348010c8c8c8c8cdd2a400066082008660826ea000ccc104dd4001198209ba80014bd701919806000a40006601800a90001919805800a40006601600890011919805000a400066014006900219ba548000cc0f4dd41bad33033303500248010cc0f4dd41bad330333035002480192f5c0607c0066078004600200244444a66607400826607666ec000c0092f5bded8c0264646464a66607266ebccc01401c004cdd2a400097ae013303f3376000e00c0102a66607266ebc01c0044cc0fccdd800380300189981f99bb000100233333009009003007006005303b003303b002303e005303c004223253330323370e90010008801099190009bad303a0013030003303000222323253330323370e9001000899ba5480092f5c02646466e9520003303a3750646eb4cc0c4c0cc01d20020014bd701bad303a00130300023030001330034bd708101000081010100810102001180a1981b99981899b87375a6605a605e0069004000a60103d87a80004c0103d8798000330373330313370e004002980103d87a80004c0103d87980004bd701800800911299981a001099ba5480092f5c026464a6660626006004266e95200033037375000497ae013330050050010033038003375a606c0046600803e4a666058600e6605060540029001099191981799299981799b87480000044c8c8c8c8c8c8c8c8c8c94ccc0f8c104008526153303b4901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607e002607e0046eb4c0f4004c0f4008dd6981d800981d8011bad30390013039002375c606e002605a0042a6606292012b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302d0013374a90001981a000a5eb80c0d0004c0a8c94ccc0b4cdc3a4008605800220022a6605e9212a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633028302a33028302a00148009200413374a900125eb80dd7181880098138108a99981499b874800806c4c8c8c8c8c8c8c048cc0d4ccc0bcccc02c08c08809130103d87a80004c0103d87980003303533302f3371e00a004980103d87a80004c0103d87980003303533302f33007375866056605a66056605a04c90002400800298103d87a80004c0103d87980004bd7019ba548000cc0d0dd30011981a1ba90014bd70191bae3302a302c00148008cc0480088c058dd98009919191919199801000911991199981000100081281300080125eb7bdb180cc00c0148dd5998169817800a400060020024444a66606e006200226464666600c00c0020086600800400660760086eacc0e400cc0040048894ccc0d000852f5c0264646606e6e98c00c008ccc01401400400cc0e000cc0d8008cc01007c94ccc0b0c01ccc0a0c0a80052002132323302f32533302f3370e9000000899191919299981c181d80109981a19816801919191981b99299981b99b87480000044c8c8c8c94ccc100c10c008526153303d491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a608200260820046eb4c0fc004c0d400c54cc0e52412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e7400163035002330373253330373370e90000008991919191919299982118228010a4c2a6607e921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a608600260860046eb4c104004c104008dd6981f800981a8010a9981ca4812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e7400163035001498c0e4008c0dc005261533035491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c607200260720046eacc0dc004c0b400854cc0c52412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302d0013374a90001981a000a5eb80c0d0004c0a8c94ccc0b4cdc3a4008605800220022a6605e9212a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633028302a33028302a00148009200413374a900125eb80dd7181880098138108a5022323300800123375e002006660060044a666056600c002264646605c64a66605c66e1d20000011323232325333037303a0021330333302c00323232330363253330363370e9000000899191919299981f98210010a4c2a66078921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a608000260800046eb4c0f8004c0d000c54cc0e12412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e7400163034002330363253330363370e90000008991919191919299982098220010a4c2a6607c921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a608400260840046eb4c100004c100008dd6981f000981a0010a9981c24812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e7400163034001498c0e0008c0d8005261533034491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c607000260700046eacc0d8004c0b000854cc0c12412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c0013374a900019819800a5eb80c0cc004c0a4c94ccc0b0cdc3a4008605600220022a6605c9212a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e0016330273029001480104cdd2a400497ae03001001222533302e00214bd70099191919299981699b87480080044ccc01c01c00c0144c8c8cc0d4004ccc02402401401cc0d4004c0ac008c0ac004c00c008c0c800cc0c00088c8c94ccc0a0cdc3a4008002264944c0980085281813000998111812000a400844464646600c0024646466e3c004014dd71819000981419299981599b8748008c0a8004400454cc0b52412a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163302630283302630280014800120003300700323232533302b3370e9001000899251302900214a060520026604a604e6604a604e002900024000646464640026eb8c0c4004c09cc94ccc0a8cdc3a4004605200220022a6605892012a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633025302733025302733025302700148009200048000c0bc004c094c94ccc0a0cdc3a4000604e00220022a660549212a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300800323375e66048604c0029000001180080091129998150010a50132325333027300300214a2266600a00a002006605c00660580046002002444a666050004297ae0132325333025300300213302b0023330050050010031333005005001003302c003302a0023001001222533302600213374a900125eb804c8c94ccc08cc00c0084cdd2a40006605200497ae01333005005001003302a0033028002300100122533302300114a226464a6660400042660080080022940c09c008cdc3a400460426ea8c09400488c8c8c8cdd2a40006604c6e9c00ccc098dd4800a5eb80ccc01400888cc88c02ccdc50010008008010009803244100330060020013001001222253330220031001132323333006006001004330040020033026004375c604800646e48004c0040048894ccc07800852f5c026464660426ea4c00c008ccc01401400400cc08800cc0800088888cccc01401000c008004c004004888894ccc074010400c4c8c8c8c8ccccc02402400cccccc02801c004008018014018014c07800cc078008c084014c07c010c0040048888894ccc0700144cc074cdd8002001a5eb7bdb1804c8c8c8c94ccc06ccdd79980280400099ba5480012f5c026604266ec002001c02454ccc06ccdd780400089919299980e99b87480000044c8c8cc094cdd80060008039812800980d8010802980d80099980300400380109981099bb000100233333300a00a003008007006005301d003301d0023020006301e0052223374a90001980c99ba548000cc064dd419b80375a6601e602200490001bad3300f301100148000cc064dd419b80375a6601e602200490011bad3300f301100148008cc064dd419b80375a6601e602200490021bad3300f3011001480112f5c097ae0223322533301333720004002266e9520004bd700a99980999b8f00200113374a900125eb804cdd2a400897ae037660046ecc004c034018dd61980498059980498058022400090021bac33008300a33008300a0034800120003012001300832533300b3370e9001180500088008a99806a4812a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633006300800148008526163001001222533300d00214984cc024c004c03c008ccc00c00cc040008004cc0040052000222233330073370e00200601c4666600a00a66e00011200230100010020022300737540024600a6ea80055cd2b9b5738aae7555cf2ab9f5740ae855d11f5f6";
        let inputs = "958258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c008258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c018258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c028258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c038258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c048258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c058258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c068258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c078258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c088258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c098258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0a8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0b8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0c8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0d8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0e8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c0f8258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c108258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c118258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c128258205a9f17b3af7757f89b99dd1b24bc1fe612a476ed4b29fb56bca3499ce2c7f13c138258206df7b1c45dfe4ed78bc4406ea601329b5dd3d4d83deab80a957b2dd3d3a154f91864";
        let outputs = "95a300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f58208e1c4232d4206dea0591772f1cc47548504d84cac258ee31176977abeca83fdb1a007ed75b1a094fbd981a002e6bde00ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f582015a09b780e7a213d465f525e26d281fe771fb3dcd3c1a83ffd1554150438e29d1a007087741a1506cd001a004fa2d502ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820f1360c66060cda107bfba609d8832881c87d3a37071c67a8abd76fdb1760271a1a0032e4411a03c174dd1a0046fcb702ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820535868db5f813f9ad586fd48f5ce08d8fc129863038cfe67632316a9e86e70871a009142ec1a01302e331a0018099b02ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f582098dcd4c69c6ae24d052533a7b63beac92e116423069cf00fa59dbf202ac208431a004747bd1a01302e331a000923a301ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f58209c2647cbe94711507730415a7cea56492cbcd2c58e0a76be4984eb316ec804cc1a005810921a1739aead1a0010697901ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820c7ddd08205063957e3cee3966e47dc4dc69201a14e57c422778f043558150c9e1a0054c4261a0eca615d1a0053eff001ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820d6e992841b6883b58834b1a15d0151c71fa27f24845c3e945b477843a0a6df441a00475f911a04d578671a0018ba3601ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f58200eb0a3010135b52dfa7c1be925b41ae78f98f730c694ee417bf22fc4381bb1e61a008e9ffc1a0eca615d1a002c7ac201ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f58208e1c4232d4206dea0591772f1cc47548504d84cac258ee31176977abeca83fdb1a007ed75b1a1506cd001a0035648200ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820c1a46520f70be4a210fe817e7f1e956ae90534dbc573bb068abad4007c4cc36b1a0091ced61a01302e331a005abde100ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f582046a348a93694561410fda071dd99d4bb13d2657782821d980a438769bc9e540c1a0094b10c1a010ab5111a0002b85200ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f58201f161aa9ec7b342c6c8b3f34361149274f2ecca885537185f3c9aa32c00b50f21a005bf2c21a0389bb441a0026214002ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820c7ddd08205063957e3cee3966e47dc4dc69201a14e57c422778f043558150c9e1a0054c4261a0389bb441a001c489901ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f58204534688ea53b66066a40da1b6737ede6698344b8bc01355590e1d98aaeba5d711a0072f3181a1739aead1a003a697d00ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820231ba0316f01460fe2ee838823b96d012a5d1c1954860d61a96d02d9f48ab2ab1a0010acee1a1739aead1a0028d2d501ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820a8618ccc0179defe3e65fe958d860adcf96ca6b05d0cc854f1b7d10f617d64cb1a0086bcb11a0eca615d1a000ed4e500ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f582050f0a2cd34228e558acea6aa8a6a0d88a9eb1ce249cd5dda29758d782402f10e1a002b6a891a010ab5111a0037af8d02ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820eb2e7f4200177c7970be21c00df5c36c3fc4ebc859c8cb7409eeacc835e268bf1a004fea911a03c174dd1a0013c2fc02ffa300581d70080a80487a282e59597f49c1cafa2ab0bce31dfe523e599694dfb94e0100028201d8185836d8799f5820506f89b7afa5b6b1b5fee97ef3d961b37dbf7ad783d40c1e3f73470541d5df5a1a0023c4e41a0eca615d1a00143c1b02ff82581d60f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d1b0000001748756d4b";
        let cost_mdls = "a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0223accc0a1a009063b91903fd0a1a02515e841980b30a";

        let slot_config = SlotConfig {
            zero_time: 1596059091000,
            zero_slot: 0,
            slot_length: 1000,
        };

        let ex_budget = ExBudget {
            cpu: 10000000000,
            mem: 16000000,
        };

        let redeemer = eval_phase_two(tx_hex, inputs, outputs, cost_mdls, ex_budget, slot_config);

        assert!(redeemer.is_err());
        let error_msg = redeemer.map_err(|err| format!("{:?}", err)).err().unwrap();
        //println!("{:?}", error_msg);
        assert!(error_msg.contains("RedeemerError"));
        assert!(error_msg.contains("OutOfExError"));
    }

    // Hydra transaction with the following ledger params:
    // shelley-genesis: minFeeA: 1
    // shelley-genesis: minFeeB: 1
    // protocol-parameters: utxoCostPerWord: 0
    // protocol-parameters: utxoCostPerByte: 0
    // protocol-parameters: executionUnitPrices.priceMemory: 0
    // protocol-parameters: executionUnitPrices.priceSteps: 0

    #[test]
    pub fn eval_phase_test_large_hydra_tx_with_adjusted_ledger_params_works() {
        let tx_hex = "84a600981a82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270082582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270182582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270282582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270382582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270482582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270582582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270682582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270782582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270882582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270982582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270a82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270b82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270c82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270d82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270e82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270f82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271082582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271182582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271282582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271382582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271482582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271582582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271682582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271782582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271818825820245a37f2346ef85ffc40d21ab16d69bb407715a31fee9ccb8a6fe723bb37d27c010182a300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa011a000f4240028201d8185901f1d8799fb2d8799f1a02bf04b01a00053656ffd8799f001a004aefb800ffd8799f1a02bf04b01a0005a48cffd8799f1a009036500000ffd8799f1a02bf04b01a000f428fffd8799f1a0077a8e80000ffd8799f1a02bf04b01a000fad3effd8799f1a004aefb80000ffd8799f1a02bf04b01a002b118cffd8799f1a001434b80000ffd8799f1a02bf04b01a002d83c1ffd8799f00001a00895474ffd8799f1a02bf04b01a00393912ffd8799f1a009436e70000ffd8799f1a02bf04b01a00420219ffd8799f1a009436e7001a00b9010fffd8799f1a053b5fc01a0006d88dffd8799f001a004aefb81a003fc074ffd8799f1a053b5fc01a001567edffd8799f00001a009436e7ffd8799f1a053b5fc01a00221ec2ffd8799f00001a00637430ffd8799f1a053b5fc01a00411e9fffd8799f1a007c01980000ffd8799f1a053b5fc01a0057b7d7ffd8799f1a00189ae40000ffd8799f1a053b5fc01a005aee81ffd8799f1a004aefb80000ffd8799f1a0738ce8f1a00020cd1ffd8799f00001a00272590ffd8799f1a0738ce8f1a000cbfcaffd8799f1a000c2b1b0000ffd8799f1a0738ce8f1a000eafc0ffd8799f00001a00acd1cbffd8799f1a0738ce8f1a000f68cbffd8799f001a0063743000ff5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff82581d60f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d1b000000746a04544702000d81825820245a37f2346ef85ffc40d21ab16d69bb407715a31fee9ccb8a6fe723bb37d27c011082581d60f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d1b000000746a139687111a000f4240a2059819840000d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840001d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840002d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840003d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840004d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840005d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840006d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840007d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840008d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840009d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff82000084000ad8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff82000084000bd8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff82000084000cd8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff82000084000dd8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff82000084000ed8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff82000084000fd8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840010d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840011d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840012d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840013d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840014d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840015d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840016d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff820000840017d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff82000084001818d8799f5820d62c08cd2f8cf109238264d211e390496499d7e5e6b07a798f949d37586fe125ff8200000681590eb6590eb30100003232323232323232323232323222232533300932323232323232323232323232323232323232323232323232323232323232323232533302b3370e900000f099191919191919180b1981c199819000a60103d87a80004c0103d87980003303833303233300f0270260284c0103d87a80004c0103d8798000330383330323300837586605c60606605c606005690002400800498103d87a80004c0103d87980004bd7019b8f0050023374a90001981b1ba600233036375200297ae032375c66058605c00290011980a8011180c9bb30013232323232323232330010094bd6f7b6301800800911299981e0010800899191919191999814199804004002003199911199980625eb7bdb18000c008004cdd2a4000660846ea0008cc108dd4000a5eb80cdd2a4000660846ea0dd69981c181d001a4004660846ea0dd69981c181d001a4008660846ea0dd69981c181d001a400c97ae002e02d02e375a6606e607200890031bad33036303800348010c8c8c8c8cdd2a400066086008660866ea000ccc10cdd4001198219ba80014bd701919806000a40006601800a90001919805800a40006601600890011919805000a400066014006900219ba548000cc0fcdd41bad33035303700248010cc0fcdd41bad330353037002480192f5c06080006607c004600200244444a66607800826607a66ec000c0092f5bded8c0264646464a66607666ebccc01401c004cdd2a400097ae01330413376000e00c0102a66607666ebc01c0044cc104cdd800380300189982099bb000100233333009009003007006005303d003303d0023040005303e004223253330343370e90010008801099190009bad303c0013032003303200222323253330343370e9001000899ba5480092f5c02646466e9520003303c3750646eb4cc0ccc0d401d20020014bd701bad303c00130320023032001330034bd708101000081010100810102001180b9981c99981999b87375a6605e60620069004000a60103d87a80004c0103d8798000330393330333370e004002980103d87a80004c0103d87980004bd701800800911299981b001099ba5480092f5c026464a6660666006004266e95200033039375000497ae01333005005001003303a003375a6070004660080444a66605c60146605460580029001099191981899299981899b87480000044c8c8c8c8c8c8c8c8c8c94ccc100c10c008526153303d4901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a608200260820046eb4c0fc004c0fc008dd6981e800981e8011bad303b001303b002375c6072002605e0042a6606692012b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302f0013374a90001981b000a5eb80c0d8004c0b0c94ccc0bccdc3a4008605c00220022a660629212a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163302a302c3302a302c00148009200413374a900125eb80dd7181980098148118a99981599b87480080784c8c8c8c8c8c8c8c058cc0e0ccc0c8ccc03c09c0980a130103d87a80004c0103d8798000330383330320014c0103d87a80004c0103d8798000330383330323300837586605c60606605c606005690002400800498103d87a80004c0103d87980004bd7019b8f0050023374a90001981b1ba600233036375200297ae032375c66058605c00290011980a8011180c9bb3001323232323233300200122332233330230020010280290010024bd6f7b6301980180291bab3302f303100148000c00400488894ccc0e400c40044c8c8cccc018018004010cc01000800cc0f4010dd5981d8019800800911299981b0010a5eb804c8c8cc0e4dd31801801199802802800801981d001981c00119802011129998171805198151816000a40042646466062601200266e952000330360014bd70181b000981619299981799b8748010c0b8004400454cc0c524012a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163302a302c3302a302c00148009200413374a900125eb80dd7181980098148118a5022323300b00123375e002006660060044a66605a60120022646466060601000266e952000330350014bd70181a800981599299981719b8748010c0b4004400454cc0c12412a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633029302b001480104cdd2a400497ae03001001222533303000214bd70099191919299981799b87480080044ccc01c01c00c0144c8c8cc0dc004ccc02402401401cc0dc004c0b4008c0b4004c00c008c0d000cc0c80088c94ccc0a4cdc3a4000002264646464a666064606a00426605c6600e006464646606264a66606266e1d2000001132323232533303a303d002149854cc0dd241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607600260760046eb4c0e4004c0bc00c54cc0cd2412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302f002330313253330313370e90000008991919191919299981e181f8010a4c2a66072921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607a002607a0046eb4c0ec004c0ec008dd6981c80098178010a99819a4812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302f001498c0cc008c0c400526153302f491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c606600260660046eacc0c4004c09c00854cc0ad2412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e74001630270013001001222533302d00214984cc0a4c004c0bc008ccc00c00cc0c00080048c8c94ccc09ccdc3a4008002264944c0940085281812800998109811800a400844464646600c0024646466e3c004014dd71818800981399299981519b8748008c0a4004400454cc0b12412a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163302530273302530270014800120003300700323232533302a3370e9001000899251302800214a0605000266048604c66048604c002900024000646464640026eb8c0c0004c098c94ccc0a4cdc3a4004605000220022a6605692012a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633024302633024302633024302600148009200048000c0b8004c090c94ccc09ccdc3a4000604c00220022a660529212a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300800323375e66046604a0029000001180080091129998148010a50132325333026300300214a2266600a00a002006605a00660560046002002444a66604e004297ae0132325333024300300213302a0023330050050010031333005005001003302b00330290023001001222533302500213374a900125eb804c8c94ccc088c00c0084cdd2a40006605000497ae0133300500500100330290033027002300100122533302200114a226464a66603e0042660080080022940c098008cdc3a400460406ea8c09000488c8c8c8cdd2a40006604a6e9c00ccc094dd4800a5eb80ccc01400888cc88c02ccdc50010008008010009803244100330060020013001001222253330210031001132323333006006001004330040020033025004375c604600646e48004c0040048894ccc07400852f5c026464660406ea4c00c008ccc01401400400cc08400cc07c0088888cccc01401000c008004c004004888894ccc070010400c4c8c8c8c8ccccc02402400cccccc02801c004008018014018014c07400cc074008c080014c078010c0040048888894ccc06c0144cc070cdd8002001a5eb7bdb1804c8c8c8c94ccc068cdd79980280400099ba5480012f5c026604066ec002001c02454ccc068cdd780400089919299980e19b87480000044c8c8cc090cdd80060008039812000980d0010802980d00099980300400380109981019bb000100233333300a00a003008007006005301c003301c002301f006301d0052223374a90001980c19ba548000cc060dd419b80375a6601c602000490001bad3300e301000148000cc060dd419b80375a6601c602000490011bad3300e301000148008cc060dd419b80375a6601c602000490021bad3300e3010001480112f5c097ae0223322533301233720004002266e9520004bd700a99980919b8f00200113374a900125eb804cdd2a400897ae037660046ecc004c030014dd6198041805198041805002a400090021bac3300730093300730090044800120003011001300732533300a3370e9001180480088008a9980624812a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163300530070024800852616330093253330093370e900000089919299980818098010a4c2a6601a9201334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c6022002600e0062a66601266e1d20020011323253330103013002149854cc0352401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c6022002600e0062a660169212b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300700200233001001480008888cccc01ccdc38008018071199980280299b8000448008c0400040080088c01cdd5000918029baa0015734ae6d5ce2ab9d5573caae7d5d02ba15745f5f6";
        let inputs = "981a82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270082582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270182582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270282582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270382582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270482582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270582582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270682582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270782582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270882582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270982582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270a82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270b82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270c82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270d82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270e82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95270f82582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271082582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271182582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271282582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271382582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271482582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271582582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271682582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271782582010856e21b5f63365f1d0e8d596da5714254d10c63988d3fdecaec33d2d0f95271818825820245a37f2346ef85ffc40d21ab16d69bb407715a31fee9ccb8a6fe723bb37d27c01";
        let outputs = "981aa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820f7549d925a9cfc54cf51dc5a810e771ca1159e54aef67e6d3a681835d8ef603f1a004aefb81a02bf04b01a0005365601ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200fe12b8ce0b2684d37e28018b9a9d0a53a3486f768804f670c409982c0a109fc1a001434b81a02bf04b01a0005a48c02ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820b176a2c47d10ded93c7d87c929135a15c7a5d4c2b0e27b3ed865442a82a2eb641a007c01981a02bf04b01a0005a48c02ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200fe12b8ce0b2684d37e28018b9a9d0a53a3486f768804f670c409982c0a109fc1a001434b81a02bf04b01a000f428f02ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820572fdd9803ae9c27a9ac6bd1d54982fe306f987e5ca14685258a19693c77ba871a006374301a02bf04b01a000f428f02ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820f7549d925a9cfc54cf51dc5a810e771ca1159e54aef67e6d3a681835d8ef603f1a004aefb81a02bf04b01a000fad3e02ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200fe12b8ce0b2684d37e28018b9a9d0a53a3486f768804f670c409982c0a109fc1a001434b81a02bf04b01a002b118c02ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820cdc2a347cf25d40f742d738cceba0427c3ca74553ae89f7ea180e53556b55d6f1a008954741a02bf04b01a002d83c100ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200432b67a01674ddb2364fa1ed34f9a72e364030c52d2e8a981df7e21ede955bd1a009436e71a02bf04b01a0039391202ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820a45575e3a21da3b7ac7bf7356564be05a573d26ad9b83a264a584fe50b00fecc1a003cff771a02bf04b01a0042021900ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200432b67a01674ddb2364fa1ed34f9a72e364030c52d2e8a981df7e21ede955bd1a009436e71a02bf04b01a0042021902ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820b176a2c47d10ded93c7d87c929135a15c7a5d4c2b0e27b3ed865442a82a2eb641a007c01981a02bf04b01a0042021900ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820f7549d925a9cfc54cf51dc5a810e771ca1159e54aef67e6d3a681835d8ef603f1a004aefb81a053b5fc01a0006d88d01ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820a915b8538e4348b39972ad74ed03ca70c1fb8f4547650dae75c9818eca01ff111a00189ae41a053b5fc01a0006d88d00ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200a7b6856d2df44cf75b9f56744a60397368898a19382b36872478e0093e84aad1a002725901a053b5fc01a0006d88d00ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200432b67a01674ddb2364fa1ed34f9a72e364030c52d2e8a981df7e21ede955bd1a009436e71a053b5fc01a001567ed00ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820572fdd9803ae9c27a9ac6bd1d54982fe306f987e5ca14685258a19693c77ba871a006374301a053b5fc01a00221ec200ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820b176a2c47d10ded93c7d87c929135a15c7a5d4c2b0e27b3ed865442a82a2eb641a007c01981a053b5fc01a00411e9f02ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820a915b8538e4348b39972ad74ed03ca70c1fb8f4547650dae75c9818eca01ff111a00189ae41a053b5fc01a0057b7d702ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820f7549d925a9cfc54cf51dc5a810e771ca1159e54aef67e6d3a681835d8ef603f1a004aefb81a053b5fc01a005aee8102ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200a7b6856d2df44cf75b9f56744a60397368898a19382b36872478e0093e84aad1a002725901a0738ce8f1a00020cd100ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820a3def0c11f1801a8bbf686de133a7c09d02d0df841666aaa02e1b999b7ff961e1a000c2b1b1a0738ce8f1a000cbfca02ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f58200432b67a01674ddb2364fa1ed34f9a72e364030c52d2e8a981df7e21ede955bd1a009436e71a0738ce8f1a000eafc000ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820a915b8538e4348b39972ad74ed03ca70c1fb8f4547650dae75c9818eca01ff111a00189ae41a0738ce8f1a000eafc000ffa300581d70dc3d57397402e20f4f62eb6137a7e62d35c469d15204e60dcee860aa0100028201d8185836d8799f5820572fdd9803ae9c27a9ac6bd1d54982fe306f987e5ca14685258a19693c77ba871a006374301a0738ce8f1a000f68cb01ff82581d60f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d1b000000746a139687";
        let cost_mdls = "a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0223accc0a1a009063b91903fd0a1a02515e841980b30a";

        let slot_config = SlotConfig {
            zero_time: 1596059091000,
            zero_slot: 0,
            slot_length: 1000,
        };

        let ex_budget = ExBudget {
            cpu: 9223372036854775806,
            mem: 9223372036854775806,
        };
        let redeemer = eval_phase_two(tx_hex, inputs, outputs, cost_mdls, ex_budget, slot_config);

        println!("{:?}", redeemer);

        assert!(redeemer.is_ok());
    }

    // this transaction is from a modified hydra ledger where shelley-genesis has been adjusted to contain minFee: 1, minFeeB: 1, utxoCostPerWord: 0 utxoCostPerByte: 0
    // See https://github.com/bloxbean/aiken-jna-wrapper/issues/4
    // we still have not figured why this transaction doesn't work but it has somewhere negative / signed outputs...
    //#[test]
    // pub fn eval_phase_test_large_hydra_tx_with_adjusted_params_works2() {
    //     let tx_hex = "84a600838258200c8644756fbd3e75f6702930db5e45aebe3e5bb3aa0d825b2d7895e1955f5e69008258200c8644756fbd3e75f6702930db5e45aebe3e5bb3aa0d825b2d7895e1955f5e69018258200c8644756fbd3e75f6702930db5e45aebe3e5bb3aa0d825b2d7895e1955f5e69020182a300581d70c2d43417ca2475019ca9ae6a0b4393ef8275aefdd26acb792131187e011a000f4240028201d8185873d8799fa3d8799f1a039d3cdb1a002acb8dffd8799f1a00885c760000ffd8799f1a18d485a91a00595cadffd8799f00001a0044d669ffd8799f1a185cede71a00435778ffd8799f001a0023b1fa00ff5820e894512825e98a423cf6ac44bfbe27f17cdf07be6f746cbe9f2d7f07a20d71ab00ff82581d60f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d3a000f423f02000d81825820c4370f145c7c1bb0734ca90e9a93f04ca36f087c91de350a462a14365de29aaf0a1082581d60f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d1a3b9aa106111a000f4240a20583840000d8799f5820e894512825e98a423cf6ac44bfbe27f17cdf07be6f746cbe9f2d7f07a20d71abff820000840001d8799f5820e894512825e98a423cf6ac44bfbe27f17cdf07be6f746cbe9f2d7f07a20d71abff820000840002d8799f5820e894512825e98a423cf6ac44bfbe27f17cdf07be6f746cbe9f2d7f07a20d71abff820000068158fd58fb0100003232323232323232323232323232222533300a323232533300d3370e900000089919251375c6028002601600a264646464944dd6980b000980b0011bae3014001300b005300b0043011001300832533300b3370e9001180500088008a99806a4812a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e001633006300800148008526163001001222533300d00214984cc024c004c038008ccc00c00cc03c008004cc0040052000222233330073370e00200601a4666600a00a66e000112002300f0010020022300737540024600a6ea80055cd2b9b5738aae7555cf2ab9f5742ae89f5f6";
    //     let inputs = "838258200c8644756fbd3e75f6702930db5e45aebe3e5bb3aa0d825b2d7895e1955f5e69008258200c8644756fbd3e75f6702930db5e45aebe3e5bb3aa0d825b2d7895e1955f5e69018258200c8644756fbd3e75f6702930db5e45aebe3e5bb3aa0d825b2d7895e1955f5e6902";
    //     let outputs = "83a300581d70c2d43417ca2475019ca9ae6a0b4393ef8275aefdd26acb792131187e0100028201d8185836d8799f5820597a7a58d23dc54ad69f86916d59201425585fbd2eec31dca8fc592e28f2c0851a0044d6691a18d485a91a00595cad00ffa300581d70c2d43417ca2475019ca9ae6a0b4393ef8275aefdd26acb792131187e0100028201d8185836d8799f58204210bd8a2c44db9ac68ae56d076bf690fe6bee79e564c0b551e883943aa33aec1a00885c761a039d3cdb1a002acb8d02ffa300581d70c2d43417ca2475019ca9ae6a0b4393ef8275aefdd26acb792131187e0100028201d8185836d8799f5820b7d3edbd94305cd319c1bdb5ac95b176002b55e73b1c5c121cce5d85ee06a2c21a0023b1fa1a185cede71a0043577801ff";
    //     let cost_mdls = "a10198af1a0003236119032c01011903e819023b00011903e8195e7104011903e818201a0001ca761928eb041959d818641959d818641959d818641959d818641959d818641959d81864186418641959d81864194c5118201a0002acfa182019b551041a000363151901ff00011a00015c3518201a000797751936f404021a0002ff941a0006ea7818dc0001011903e8196ff604021a0003bd081a00034ec5183e011a00102e0f19312a011a00032e801901a5011a0002da781903e819cf06011a00013a34182019a8f118201903e818201a00013aac0119e143041903e80a1a00030219189c011a00030219189c011a0003207c1901d9011a000330001901ff0119ccf3182019fd40182019ffd5182019581e18201940b318201a00012adf18201a0002ff941a0006ea7818dc0001011a00010f92192da7000119eabb18201a0002ff941a0006ea7818dc0001011a0002ff941a0006ea7818dc0001011a0011b22c1a0005fdde00021a000c504e197712041a001d6af61a0001425b041a00040c660004001a00014fab18201a0003236119032c010119a0de18201a00033d7618201979f41820197fb8182019a95d1820197df718201995aa18201a0223accc0a1a009063b91903fd0a1a02515e841980b30a";

    //     let slot_config = SlotConfig {
    //         zero_time: 1596059091000,
    //         zero_slot: 0,
    //         slot_length: 1000,
    //     };

    //     let ex_budget = ExBudget {
    //         cpu: 9223372036854775806,
    //         mem: 9223372036854775806,
    //     };
    //     let redeemer = eval_phase_two(tx_hex, inputs, outputs, cost_mdls, ex_budget, slot_config);

    //     println!("{:?}", redeemer);

    //     assert!(redeemer.is_ok());
    // }

    #[test]
    pub fn apply_params_to_plutus_script_test() {
        let compiledCode = "590221010000323232323232323232323223222232533300b32323232533300f3370e9000180700089919191919191919191919299980e98100010991919299980e99b87480000044c94ccc078cdc3a4000603a002264a66603e66e1c011200213371e00a0322940c07000458c8cc004004030894ccc088004530103d87a80001323253330213375e6603a603e004900000d099ba548000cc0940092f5c0266008008002604c00460480022a66603a66e1c009200113371e00602e2940c06c050dd6980e8011bae301b00116301e001323232533301b3370e90010008a5eb7bdb1804c8dd59810800980c801180c800991980080080111299980f0008a6103d87a8000132323232533301f3371e01e004266e95200033023374c00297ae0133006006003375660400066eb8c078008c088008c080004c8cc004004008894ccc07400452f5bded8c0264646464a66603c66e3d221000021003133022337606ea4008dd3000998030030019bab301f003375c603a0046042004603e0026eacc070004c070004c06c004c068004c064008dd6180b80098078029bae3015001300d001163013001301300230110013009002149858c94ccc02ccdc3a40000022a66601c60120062930b0a99980599b874800800454ccc038c02400c52616163009002375c0026600200290001111199980399b8700100300c233330050053370000890011807000801001118029baa001230033754002ae6955ceaab9e5573eae815d0aba201";
        let params = "9f474d79546f6b656ed8799f58201f3f766bc864c3f8ce8ccc20716e3f3cf65f08a819073c75875ea4e67549947f00ffff";

        let script = apply_params_to_plutus_script(params, compiledCode);

        println!("{:?}", script);

        assert!(script.is_ok());
    }
}
